@startuml
' Improved Class Diagram - Better Readability
title Architectural Blueprint - Class Diagram (Clean Layout)

' Clean layout configuration with better spacing
left to right direction
skinparam linetype ortho
skinparam ranksep 100
skinparam nodesep 100
skinparam classAttributeIconSize 0
skinparam minClassWidth 100
skinparam arrowThickness 3
skinparam dpi 150

' Color-coded layers
skinparam package {
    BorderColor #2C3E50
    FontColor #2C3E50
    FontSize 11
    FontStyle bold
    RoundCorner 8
}

skinparam class {
    BorderColor #34495E
    BackgroundColor #FFFFFF
    ArrowColor #7F8C8D
    FontSize 9
    RoundCorner 5
}

skinparam note {
    BackgroundColor #FFF3CD
    BorderColor #FFEAA7
    FontSize 8
}

' === Configuration Layer (Blue Theme) ===
package "Configuration" as config #E3F2FD {
    class Settings <<Singleton>> #BBDEFB {
        +GEMINI_API_KEY: str
        +POSTGRES_DSN: str  
        +KAFKA_BOOTSTRAP_SERVERS: list
        +CHROMA_HOST: str
        --
        +get_config(): dict
    }
}

' === Data Models (Green Theme) ===
package "Data Models" as models #E8F5E8 {
    interface IDocument #A5D6A7 {
        +get_id(): str
        +get_content(): str
        +get_metadata(): dict
        +validate(): bool
    }
    
    interface IChunk #A5D6A7 {
        +get_text(): str
        +get_embedding(): vector
        +get_document_id(): str
    }
    
    class Document #C8E6C9 {
        -id: str
        -content: str
        -metadata: dict
        -created_at: datetime
        --
        +get_id(): str
        +get_content(): str
        +get_metadata(): dict
        +validate(): bool
        +update_metadata(): bool
    }
    
    class Chunk #C8E6C9 {
        -id: str
        -text: str
        -embedding: vector
        -document_id: str
        --
        +get_text(): str
        +get_embedding(): vector
        +get_document_id(): str
        +to_dict(): dict
    }
    
    class ExtractionSchema #C8E6C9 {
        -fields: list
        -validation_rules: dict
        -created_by: str
        --
        +get_fields(): list
        +add_field(): bool
        +validate_data(): bool
        +to_json(): str
    }
    
    class ExtractionResult #C8E6C9 {
        -document_id: str
        -extracted_data: dict
        -confidence: float
        -timestamp: datetime
        --
        +get_data(): dict
        +get_confidence(): float
        +is_valid(): bool
        +merge_with(): ExtractionResult
    }
}

' === Infrastructure Layer (Orange Theme) ===
package "Infrastructure" as infra #FFF3E0 {
    interface IAPIController #FFCC80 {
        +handle_request(): Response
        +validate_input(): bool
    }
    
    interface IWorkflowOrchestrator #FFCC80 {
        +start_workflow(): Task
        +monitor(): Status
    }
    
    class DocumentIngestionAPI #FFCC80 {
        -file_validator: FileValidator
        -event_publisher: IEventPublisher
        --
        +upload_document(): Response
        +get_status(): Status
        +list_documents(): List
    }
    
    class DocumentProcessingOrchestrator #FFCC80 {
        -file_watcher: FileWatcherService
        -prefect_consumers: List[PrefectFlowConsumer]
        -consumer_threads: List
        --
        +start(): None
        +stop(): None
        +is_running(): bool
        +get_status(): dict
    }
    
    class FileWatcherService #FFCC80 {
        -document_producer: DocumentProducer
        -event_handler: DocumentFileHandler
        -observer: Observer
        --
        +start(): None
        +stop(): None
        +is_running(): bool
    }
    
    class PrefectFlowConsumer #FFCC80 {
        -document_producer: DocumentProducer
        -processing_files: set
        --
        +get_subscribed_topics(): list
        +process_message(): bool
        +start_consuming(): None
        +stop_consuming(): None
    }
}

' === Messaging Layer (Purple Theme) ===
package "Messaging" as messaging #F3E5F5 {
    interface IEventPublisher #CE93D8 {
        +publish(): bool
        +publish_event(): bool
    }
    
    interface IEventConsumer #CE93D8 {
        +consume(): List
        +subscribe(): bool
        +get_subscribed_topics(): List
        +process_message(): bool
    }
    
    class DocumentProducer #CE93D8 {
        -connection_manager: ConnectionManager
        --
        +send_file_detected(): bool
        +send_document_received(): bool
        +send_workflow_initialized(): bool
        +send_processing_complete(): bool
    }
    
    class BaseKafkaConsumer #CE93D8 {
        -consumer: KafkaConsumer
        -stop_event: Event
        --
        +consume_events(): List
        +subscribe_to_topic(): bool
        +start_consuming(): None
        +stop_consuming(): None
    }
    
    class EventBus #CE93D8 {
        -topic_router: TopicRouter
        --
        +publish(): bool
        +subscribe(): bool
        +get_topics(): List
    }
}

' === Document Processing Layer (Light Blue Theme) ===
package "Document Processing" as docprocessing #E1F5FE {
    interface IDocumentProcessor #81D4FA {
        +process_document(): IDocument
        +supports_all_formats(): bool
    }
    
    class DoclingProcessor #81D4FA {
        -vision_processor: VisionProcessor
        -output_manager: DocumentOutputManager
        --
        +process_document_with_vision(): ParsedDocument
        +process_document_with_duplicate_check(): Dict
        +_extract_images_to_dict(): Dict
        +_extract_document_context(): str
    }

    class DocumentOutputManager #81D4FA {
        -connection_manager: ConnectionManager
        -document_crud: DocumentCRUD
        -document_producer: DocumentProducer
        --
        +check_and_process_document(): Dict
        +save_processed_document(): Dict
        +prepare_kafka_message(): Dict
        +get_document_path_info(): Dict
    }

    class VisionProcessor #81D4FA {
        -classifier: ImageClassifier
        -vision_agent: VisionAgent
        -enhancer: MarkdownEnhancer
        --
        +process_document_images(): str
        +_process_with_classification(): Dict
        +_process_all_images(): Dict
    }

    class VisionAgent #81D4FA {
        +describe_image_async(): str
        +analyze_image(): dict
    }
    
    class ImageClassifier #81D4FA {
        +classify_image(): Dict
        +should_analyze(): bool
    }
    
    class MarkdownEnhancer #81D4FA {
        +enhance_content(): str
        +replace_image_placeholders(): str
    }
}

' === Core Services (Yellow Theme) ===
package "Core Services" as core #FFFDE7 {
    
    interface IChunker #FFF59D {
        +chunk(): List[IChunk]
        +create_embeddings(): bool
    }
    
    interface IPersistenceRepository #FFF59D {
        +save(): bool
        +retrieve(): any
        +update(): bool
        +delete(): bool
    }
    
    class SemanticChunker #FFF176 {
        -embedding_service: EmbeddingService
        --
        +chunk(): List[IChunk]
        +create_embeddings(): bool
        +optimize_chunks(): List[IChunk]
    }
    
    class PersistenceManager #FFF176 {
        -document_repo: IPersistenceRepository
        -chunk_repo: IPersistenceRepository
        -result_repo: IPersistenceRepository
        --
        +save_document(): bool
        +save_chunks(): bool
        +retrieve_data(): dict
    }
}

' === Agent Layer (Red Theme) ===
package "Agent Layer" as agents #FFEBEE {
    class OrchestratorAgent <<Schema Creator>> #FFCDD2 {
        +scan_document(): dict
        +identify_extractable_fields(): List
        +create_extraction_schema(): ExtractionSchema
    }
    
    class FieldDiscoveryAgent <<Discovery Agent>> #FFCDD2 {
        +discover_fields(): List
        +validate_field_patterns(): bool
        +analyze_document_structure(): dict
    }
    
    class ExtractionAgent <<Worker Swarm>> #FFCDD2 {
        +extract_fields(): ExtractionResult
        +process_parallel(): List[ExtractionResult]
        +validate_results(): bool
        +merge_swarm_results(): ExtractionResult
    }
}

' === Prefect Workflow Layer (Lavender Theme) ===
package "Prefect Workflows" as prefect #F8BBD9 {
    class DocumentProcessingFlow #F48FB1 {
        +document_processing_flow(): Dict
        +process_document_with_flow(): Dict
    }
    
    class DuplicateDetectionTask #F48FB1 {
        +duplicate_detection_task(): Dict
    }
    
    class VisionProcessingTask #F48FB1 {
        +vision_processing_task(): Dict
    }
    
    class DocumentSavingTask #F48FB1 {
        +document_saving_task(): Dict
    }
    
    class KafkaMessagePrepTask #F48FB1 {
        +kafka_message_preparation_task(): Dict
    }
}

' === Query & Evaluation (Cyan Theme) ===
package "Query & Evaluation" as query #E0F2F1 {
    class RAGQueryEngine #80CBC4 {
        +query(): str
        +retrieve_context(): List
        +generate_answer(): str
        +rank_results(): List
    }
    
    class RagasEvaluator #80CBC4 {
        +evaluate_performance(): dict
        +generate_metrics(): Report
        +compare_results(): dict
    }
}

' === Updated Relationships ===

' Interface implementations
Document ..|> IDocument
Chunk ..|> IChunk
DoclingProcessor ..|> IDocumentProcessor
SemanticChunker ..|> IChunker
DocumentIngestionAPI ..|> IAPIController
DocumentProcessingOrchestrator ..|> IWorkflowOrchestrator
DocumentProducer ..|> IEventPublisher
PrefectFlowConsumer ..|> IEventConsumer
BaseKafkaConsumer ..|> IEventConsumer

' Configuration dependencies (Dependency Injection)
Settings ..> DocumentIngestionAPI : injects config
Settings ..> DocumentProcessingOrchestrator : injects config
Settings ..> PersistenceManager : injects config

' File System Monitoring Flow
FileWatcherService --> DocumentProducer : uses for file-detected events
DocumentProducer --> EventBus : sends to topics

' Event-Driven Processing Flow
EventBus --> PrefectFlowConsumer : delivers file-detected events
PrefectFlowConsumer --> DocumentProcessingOrchestrator : coordinates services

' Prefect Workflow Flow
PrefectFlowConsumer --> DocumentProcessingFlow : triggers flow
DocumentProcessingFlow --> DuplicateDetectionTask : step 1
DuplicateDetectionTask --> VisionProcessingTask : step 2 (if new)
VisionProcessingTask --> DocumentSavingTask : step 3
DocumentSavingTask --> KafkaMessagePrepTask : step 4

' Document Processing Flow (Enhanced)
VisionProcessingTask --> DoclingProcessor : processes document
DoclingProcessor --> DocumentOutputManager : manages workflow
DoclingProcessor --> VisionProcessor : enhances with AI
VisionProcessor --> VisionAgent : describes images
VisionProcessor --> ImageClassifier : classifies images
VisionProcessor --> MarkdownEnhancer : enhances content

' Document Output Management
DocumentOutputManager --> PersistenceManager : saves to database
DocumentOutputManager --> DocumentProducer : prepares messages

' Orchestration Relationships
DocumentProcessingOrchestrator --> FileWatcherService : manages
DocumentProcessingOrchestrator --> PrefectFlowConsumer : manages

' Structured Extraction Flow
OrchestratorAgent --> FieldDiscoveryAgent : collaborates
OrchestratorAgent ..> ExtractionSchema : creates
ExtractionSchema --> ExtractionAgent : provides schema
ExtractionAgent ..> ExtractionResult : creates

' RAG Processing Flow (Consumes Document Processing Output)
SemanticChunker --> IDocument : processes validated documents
SemanticChunker ..> IChunk : creates

' Repository Pattern
PersistenceManager --> IPersistenceRepository : uses
IPersistenceRepository --> IDocument : persists
IPersistenceRepository --> IChunk : persists
IPersistenceRepository --> ExtractionResult : persists

' Query operations
RAGQueryEngine --> PersistenceManager : queries through
RagasEvaluator --> RAGQueryEngine : evaluates

' Data relationships
IDocument ||--o{ IChunk : contains
ExtractionSchema ||--o{ ExtractionResult : validates

@enduml