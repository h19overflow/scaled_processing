@startuml

title Scaled Document Processing System - Component Architecture
left to right direction
skinparam linetype ortho
skinparam ranksep 120
skinparam nodesep 100
skinparam classAttributeIconSize 0
skinparam minClassWidth 160
skinparam arrowThickness 2
skinparam dpi 150
' === User Interface Layer ===
package "User Interface / API" #E3F2FD {
  actor User
  [Document Ingestion API] as API
  [File Validator] as Validator
}

' === Messaging Layer ===
package "Event-Driven Messaging" #F3E5F5 {
  queue "Kafka Event Bus" as Kafka
  [Event Publisher] as Publisher
  [Event Consumer] as Consumer
  [Topic Router] as Router
}

' === Orchestration Layer ===
package "Workflow Orchestration" #FFF3E0 {
  [Prefect Orchestrator] as Prefect
  [Flow Manager] as FlowMgr
  [Task Monitor] as Monitor
}

' === Parallel Processing Flows ===
package "Structured Extraction Flow" #FFEBEE {
  [Orchestrator Agent] as OrchestratorAgent
  [Field Discovery Agent] as FieldAgent
  [Extraction Agent Swarm] as ExtractionSwarm
  [Image Agent] as ImageAgent
}

package "Document Processing Pipeline" #E1F5FE {
  [Docling Processor] as DoclingProcessor
  [Structure Analyzer] as StructureAnalyzer
  [Content Extractor] as ContentExtractor
  [Content Validator] as ContentValidator
}

package "RAG Processing Flow" #FFFDE7 {
  [Semantic Chunker] as Chunker
  [Embedding Service] as EmbeddingService
  [Vector Storage] as VectorStorage
}

' === Data Management ===
package "Data Persistence" #E8F5E8 {
  [Persistence Manager] as PersistMgr
  [Document Repository] as DocRepo
  [Chunk Repository] as ChunkRepo
  [Result Repository] as ResultRepo
}

package "Data Stores" #F5F5F5 {
  database "PostgreSQL\n(Metadata)" as Postgres
  database "ChromaDB\n(Vector Store)" as Chroma
  database "Document Store\n(Files)" as FileStore
}

' === Query & Evaluation Layer ===
package "Query & Analytics" #E0F2F1 {
  [RAG Query Engine] as RAG
  [Ragas Evaluator] as Evaluator
  [Context Retriever] as Retriever
}

' === Monitoring & Observability ===
package "Monitoring" #FFF8E1 {
  [WandB Monitoring] as WandB
  [Metrics Collector] as Metrics
  [Performance Tracker] as Perf
}

' === Configuration ===
package "Configuration" #F3E5F5 {
  [Settings Manager] as Config
}

' === PRIMARY FLOW RELATIONSHIPS ===

' 1. Document Upload Flow
User --> API : 1. Upload Document
API --> Validator : validates file
API --> Publisher : 2. Publish event
Publisher --> Kafka : sends to topics
Kafka --> Router : routes messages
Router --> Consumer : delivers events
Consumer --> Prefect : 3. Triggers workflows

' 2. Parallel Flow Orchestration
Prefect --> FlowMgr : manages flows
FlowMgr --> DoclingProcessor : 4a. Start Document Processing (First)
FlowMgr --> OrchestratorAgent : 4b. Start Structured Extraction (After Docling)
FlowMgr --> Chunker : 4c. Start RAG Processing (After Docling)
Monitor --> Prefect : monitors all flows

' 3. Structured Extraction Flow
OrchestratorAgent --> FieldAgent : collaborates on discovery
OrchestratorAgent --> ExtractionSwarm : deploys for parallel extraction
ImageAgent --> OrchestratorAgent : provides visual analysis
ImageAgent --> FieldAgent : enhances field discovery

' 4. Document Processing Flow (Sequential - First)
DoclingProcessor --> StructureAnalyzer : extracts document structure
DoclingProcessor --> ContentExtractor : extracts clean content
ContentExtractor --> ContentValidator : validates extraction quality

' 5. Parallel Processing (After Document Processing Complete)
ContentValidator --> OrchestratorAgent : sends processed document
ContentValidator --> Chunker : sends processed document

' Image Agent Integration (Unified)
ImageAgent --> DoclingProcessor : enhances visual analysis
ImageAgent --> StructureAnalyzer : provides visual insights

' 6. RAG Processing Flow (Uses Docling Output)
Chunker --> EmbeddingService : creates embeddings from chunks
EmbeddingService --> VectorStorage : stores vectors

' 7. Data Persistence (All flows converge)
ExtractionSwarm --> PersistMgr : structured results
VectorStorage --> PersistMgr : vector data
Chunker --> PersistMgr : chunks & metadata
OrchestratorAgent --> PersistMgr : schemas
ContentValidator --> PersistMgr : processed documents

' Repository Pattern
PersistMgr --> DocRepo : document operations
PersistMgr --> ChunkRepo : chunk operations  
PersistMgr --> ResultRepo : result operations

' Data Store Connections
DocRepo --> Postgres : metadata
DocRepo --> FileStore : files
ChunkRepo --> Chroma : vectors
ChunkRepo --> Postgres : chunk metadata
ResultRepo --> Postgres : extraction results

' 8. Query Flow
User --> RAG : 9. Ask question
RAG --> Retriever : gets context
Retriever --> ChunkRepo : 10a. Retrieve chunks
Retriever --> DocRepo : 10b. Get metadata
RAG --> User : 11. Synthesized answer

' 9. Evaluation & Monitoring
Evaluator --> RAG : evaluates performance
Metrics --> ExtractionSwarm : tracks extraction metrics
Metrics --> RAG : tracks query metrics
Perf --> WandB : sends performance data
Metrics --> WandB : sends agent decisions

' Configuration Dependencies
Config ..> API : provides settings
Config ..> Prefect : provides settings
Config ..> PersistMgr : provides settings
Config ..> Kafka : provides connection settings

@enduml