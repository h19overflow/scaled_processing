@startuml workflow_hybrid_query_overview
title Hybrid Query Overview - Coordinated RAG + Structured Embedding Workflows

' Define workflow components
participant "User Query\n(API Request)" as user_query
participant "RAG Query Topic\n(rag_query_requests)" as rag_topic
participant "RAG Query Workflow\n(workflow_rag_query.puml)" as rag_workflow
participant "Structured Query Topic\n(structured_query_requests)" as structured_topic
participant "Structured Query Workflow\n(workflow_structured_query.puml)" as structured_workflow
participant "Response Topic\n(query_responses)" as response_topic
participant "Final Response\n(API Response)" as final_response

' Coordinated workflow execution
user_query -> rag_topic : publish_query_request()
note right : Model: UserQueryRequest\nFunction: initiate_hybrid_search()

rag_topic -> rag_workflow : trigger_rag_processing()
note right : Workflow: workflow_rag_query.puml\nProcess: Semantic search + source extraction

rag_workflow -> structured_topic : publish_structured_query_request()
note right : Model: StructuredQueryRequest\nFunction: handoff_to_structured_search()

structured_topic -> structured_workflow : trigger_structured_processing()
note right : Workflow: workflow_structured_query.puml\nProcess: Filtered embedding search + response assembly

structured_workflow -> response_topic : publish_hybrid_response()
note right : Model: HybridQueryResponse\nFunction: complete_hybrid_search()

response_topic -> final_response : deliver_enhanced_answer()
note right : Model: FinalResponse\nFunction: return_to_user()

note over user_query, final_response
    **Hybrid Query Coordination:**
    • User Query → RAG Workflow → Structured Workflow → Enhanced Response
    • Event-driven handoff between specialized workflows
    • Each workflow optimized for its specific task
    
    **Workflow 1: RAG Query (workflow_rag_query.puml)**
    • Semantic search on document chunks
    • Source file extraction from metadata
    • Context preparation for structured search
    • Fast initial response capability
    
    **Workflow 2: Structured Query (workflow_structured_query.puml)**
    • Filtered embedding search by source files
    • Field aggregation and correlation
    • Hybrid response assembly and formatting
    • Enhanced answer with precise data points
    
    **Benefits of Split Architecture:**
    • Independent scaling of RAG vs structured search
    • Parallel optimization of each workflow
    • Clean separation of concerns
    • Async processing with event-driven coordination
    
    **Final Response Format:**
    {
      "context": "Contextual information from RAG chunks...",
      "structured_data": {"field": "value", "field2": "value2"},
      "source_documents": ["doc1.pdf", "doc2.pdf"],
      "confidence_metrics": {...}
    }
end note

@enduml